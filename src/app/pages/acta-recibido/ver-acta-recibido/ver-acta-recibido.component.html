<nb-card>
  <nb-card-header><h2>{{'GLOBAL.Acta_Recibido.VerificacionActa.TitleId' | translate: {ID: _ActaId} }}</h2>
  <label>{{'GLOBAL.Acta_Recibido.ConsultaActas.EstadoHeader' | translate}}: {{this.estadoActa}}</label>
  </nb-card-header>
  <nb-card-body [nbSpinner]="!carga_agregada">
    <form [formGroup]="firstForm" #fform="ngForm" class="step-container" *ngIf="firstForm">

        <nb-card formGroupName="Formulario1">
          <nb-card-header>{{'GLOBAL.Acta_Recibido.VerificacionActa.DatosTitle' | translate}}</nb-card-header>
          <nb-card-body>
            <div class="row" *ngIf="Acta.ActaRecibido.TipoActaId.Id === 1">
              <div class="form-group col-sm">
                <label>{{'GLOBAL.Acta_Recibido.ContratistaAsignado' | translate}}</label>
                <div class="input-group">
                  <input matInput type="text" placeholder="{{'GLOBAL.Acta_Recibido.ContratistaAsignado' | translate }}"
                    class="form-control" formControlName="Contratista" [matAutocomplete]="autoContratista">
                    <mat-autocomplete #autoContratista="matAutocomplete" [displayWith]="muestraContratista">
                      <mat-option *ngFor="let contr of contratistasFiltrados | async" [value]="contr">
                        {{muestraContratista(contr)}}
                      </mat-option>
                    </mat-autocomplete>
                </div>
              </div>
              <div class="form-group col-sm">
                <label>{{'GLOBAL.Acta_Recibido.DetalleActa.Proveedor' | translate}}</label>
                <input matInput type="text" class="form-control"
                formControlName="Proveedor" [matAutocomplete]="autoProveedor">
                <mat-autocomplete #autoProveedor="matAutocomplete" [displayWith]="muestraProveedor">
                  <mat-option *ngFor="let prov of proveedoresFiltrados | async" [value]="prov">
                    {{muestraProveedor(prov)}}
                  </mat-option>
                </mat-autocomplete>
              </div>
            </div>

            <div class="row">
              <div class="form-group col-sm">
                <label>{{'GLOBAL.Acta_Recibido.EdicionActa.Sede' | translate}}</label>
                <mat-select type="text" class="form-control" formControlName="Sede">
                  <mat-option *ngFor="let sede of Sedes" [(value)]="sede.Id">{{sede.Nombre}}</mat-option>
                </mat-select>
              </div>
              <div class="form-group col-sm">
                <label>{{'GLOBAL.Acta_Recibido.EdicionActa.Dependencia' | translate}}</label>
                <ng2-completer style="border: 0rem" inputClass="form-control" nbInput [datasource]="dataService3"
                  formControlName="Dependencia" [minSearchLength]="3" [clearUnselected]="true"
                  placeholder="{{'GLOBAL.Errores.ErrorMinLength' | translate : {NUM : minLength} }}">
                </ng2-completer>
              </div>
              <div class="form-group col-sm">
                <label>{{'GLOBAL.Acta_Recibido.EdicionActa.Ubicacion' | translate}}</label>
                <mat-select type="text" class="form-control" formControlName="Ubicacion">
                  <mat-option *ngFor="let ubicacion of UbicacionesFiltradas" [(value)]="ubicacion.Id">{{ubicacion.Nombre}}
                  </mat-option>
                </mat-select>
              </div>
            </div>
          </nb-card-body>
        </nb-card>

        <nb-card formArrayName="Formulario2">
          <nb-card-header>{{'GLOBAL.Acta_Recibido.VerificacionActa.SoporteTitle' | translate}}</nb-card-header>
          <nb-card-body>
            <mat-tab-group [selectedIndex]="selected.value" (selectedIndexChange)="selected.setValue($event)">
              <mat-tab *ngFor="let soporte of firstForm.get('Formulario2')['controls']; let i = index" [formGroupName]="i">
                <ng-template mat-tab-label>
                  {{'GLOBAL.Acta_Recibido.VerificacionActa.SoporteSubTitle' | translate}} &nbsp; {{i + 1}}
                </ng-template>
                <div>
                  <nb-card>
                    <nb-card-body>
                      <div class="row">
                        <div class="col" *ngIf="Acta.ActaRecibido.TipoActaId.Id === 1">
                          <div class="form-group col-sm">
                            <label>{{'GLOBAL.Acta_Recibido.DetalleActa.Consecutivo' | translate}}</label>
                            <div class="input-group">
                              <input nbInput type="text" placeholder="Consecutivo" class="form-control" formControlName="Consecutivo">
                            </div>
                          </div>

                          <div class="form-group col-sm">
                            <label>{{'GLOBAL.Acta_Recibido.DetalleActa.FechaSoporte' | translate}}</label>
                            <div class="input-group">
                              <input nbInput class="form-control" placeholder="{{'GLOBAL.Acta_Recibido.VerificacionActa.FechaSoporte' | translate }}"
                                [nbDatepicker]="formpicker" formControlName="Fecha_Factura">
                              <nb-datepicker #formpicker></nb-datepicker>
                            </div>
                          </div>
                        </div>

                        <div class="col">
                          <div class="form-group col-sm">
                            <label>{{'GLOBAL.Acta_Recibido.DetalleActa.Soporte' | translate}}</label>
                            <nb-card>
                              <nb-card-body>
                                <div class="col-sm soporte">
                                  <button nbButton type="button" (click)="downloadFile(i)">
                                    <i class="fas fa-eye fa-2x"></i>
                                  </button>
                                </div>
                              </nb-card-body>
                            </nb-card>
                          </div>
                        </div>
                      </div>
                    </nb-card-body>
                  </nb-card>
                </div>
              </mat-tab>
            </mat-tab-group>

            <nb-card-body>
              <div>
                <ngx-gestionar-elementos [Modo]="Modo" [ActaRecibidoId]="Acta.ActaRecibido.Id"
                  (ElementosValidos)="eventoElementosSeleccionados($event)" (DatosEnviados)="eventoElementos($event)"
                  (DatosTotales)="eventoTotales($event)"></ngx-gestionar-elementos>
              </div>
            </nb-card-body>
          </nb-card-body>
        </nb-card>

        <nb-card *ngIf="totales && elementos && elementos.length > 0">
          <nb-card-header>{{'GLOBAL.Acta_Recibido.VerificacionActa.Consolidado' | translate}}</nb-card-header>
          <nb-card-body>
            <table class="consolidado">
              <tr>
                <th id="c1" class="cell-3">{{'GLOBAL.Acta_Recibido.VerificacionActa.Subtotal' | translate}}</th>
                <td class="cell-3">{{totales.Subtotal | currency}}</td>
              </tr>
              <tr>
                <th id="c2" class="cell-3">{{'GLOBAL.Acta_Recibido.VerificacionActa.Descuento' | translate}}</th>
                <td class="cell-3">{{totales.Descuento | currency}}</td>
              </tr>
              <tr>
                <th id="c3" class="cell-3">{{'GLOBAL.Acta_Recibido.VerificacionActa.ValorIva' | translate}}</th>
                <td class="cell-3">{{totales.ValorIva | currency}}</td>
              </tr>
              <tr>
                <th id="c4" class="cell-3">{{'GLOBAL.Acta_Recibido.VerificacionActa.Total' | translate}}</th>
                <td class="cell-3">{{totales.ValorTotal | currency}}</td>
              </tr>
            </table>
          </nb-card-body>
        </nb-card>

        <nb-card formGroupName="Formulario3">
          <nb-card-header>{{'GLOBAL.Acta_Recibido.VerificacionActa.DatosAdicionales' | translate}}</nb-card-header>
          <nb-card-body>
            <div class="form-group  col-lg-12">
              <label>{{'GLOBAL.Acta_Recibido.VerificacionActa.Observaciones' | translate}}</label>
              <div class="input-group">
                <textarea rows="5" class="form-control" placeholder="{{'GLOBAL.Acta_Recibido.VerificacionActa.FechaSoporte' | translate }}"
                  formControlName="Datos_Adicionales"></textarea>
              </div>
            </div>
          </nb-card-body>
          <nb-card-footer *ngIf="Modo === 'verificar'">
            <div class="justify-content-center">
              <button nbButton (click)="Revisar_Totales2()">{{'GLOBAL.Acta_Recibido.VerificacionActa.Rechazar' |
                translate}}</button>
              <button nbButton [disabled]="!bandera" (click)="Revisar_Totales()"
                class="float-right">{{'GLOBAL.Acta_Recibido.VerificacionActa.Verificar' | translate}}</button>
            </div>
          </nb-card-footer>
        </nb-card>

    </form>
  </nb-card-body>
</nb-card>
